# Test Configuration Notes for Claude Code

## Important CI Behavior

⚠️ **CRITICAL**: When `CI=true` environment variable is set, many E2E tests are **SKIPPED** in the CI pipeline.

This is why running:
```bash
CI=true uv run pytest tests/e2e_api/test_05_vector_sync_and_search.py::test_sync_nonexistent_collection -v -s
```

Results in:
```
tests/e2e_api/test_05_vector_sync_and_search.py::test_sync_nonexistent_collection SKIPPED
```

## Correct Test Commands

### For Development/Local Testing
```bash
# Run without CI flag - tests will execute normally
uv run pytest tests/e2e_api/test_05_vector_sync_and_search.py::test_sync_nonexistent_collection -v -s

# Run all vector-related tests
uv run pytest tests/ -v -k "vector" --tb=short

# Run integration tests  
uv run pytest tests/test_vector_sync_integration.py tests/test_api_integration.py -v
```

### For CI Pipeline
```bash
# CI environment automatically sets CI=true, which skips certain tests
# This is by design to avoid flaky tests in CI
```

## Test Categories

### Always Available (No CI Skip)
- Unit tests: `tests/test_*.py` 
- Integration tests: Most integration tests run in CI
- Schema validation tests
- Service layer tests

### CI-Conditional (May Skip with CI=true)
- E2E API tests: `tests/e2e_api/`
- Vector sync tests requiring RAG dependencies
- HTTP endpoint tests requiring server startup
- Tests marked with `@pytest.mark.skipif(os.getenv("CI"))`

## Testing Strategy for Development

1. **Local Development**: Run tests without `CI=true` to get full test execution
2. **Parameter Migration Verification**: Use integration tests instead of E2E when CI skips
3. **HTTP Status Code Testing**: Use unit tests with mocked HTTP clients rather than full E2E

## RAG Dependencies Note

Some tests also check for RAG availability:
```python
from tools.knowledge_base.dependencies import is_rag_available
```

If RAG dependencies (ChromaDB, sentence-transformers) are not installed, vector-related tests may also be skipped.

## Current Known Skip Patterns

Based on test runs, these are likely to be skipped in CI:
- `test_sync_nonexistent_collection`
- `test_get_status_nonexistent_collection` 
- `test_search_with_invalid_parameters`
- Other E2E API tests in `tests/e2e_api/`

## Recommended Approach

For verifying HTTP status code implementations:
1. Use integration tests: `tests/test_api_integration.py`
2. Use vector sync integration: `tests/test_vector_sync_integration.py`
3. Check service layer tests: `tests/test_*_service.py`
4. Only use E2E tests locally (without CI=true)